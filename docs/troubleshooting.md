# ğŸ”§ inklog æ•…éšœæ’æŸ¥æŒ‡å—

## ç›®å½•

- [ç¼–è¯‘é—®é¢˜](#ç¼–è¯‘é—®é¢˜)
- [é…ç½®é—®é¢˜](#é…ç½®é—®é¢˜)
- [è¿è¡Œæ—¶é—®é¢˜](#è¿è¡Œæ—¶é—®é¢˜)
- [æ€§èƒ½é—®é¢˜](#æ€§èƒ½é—®é¢˜)
- [æ•°æ®åº“é—®é¢˜](#æ•°æ®åº“é—®é¢˜)
- [S3 å½’æ¡£é—®é¢˜](#s3-å½’æ¡£é—®é¢˜)
- [åŠ å¯†é—®é¢˜](#åŠ å¯†é—®é¢˜)
- [æ—¥å¿—æ¢å¤](#æ—¥å¿—æ¢å¤)

---

## ç¼–è¯‘é—®é¢˜

### ç¼–è¯‘å¤±è´¥ï¼šæ‰¾ä¸åˆ°ä¾èµ–

**é”™è¯¯ä¿¡æ¯**:
```
error: could not compile ... (dependency)
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ›´æ–°ä¾èµ–
cargo update

# æ¸…ç†å¹¶é‡æ–°ç¼–è¯‘
cargo clean
cargo build
```

### ç‰¹æ€§æ ‡å¿—ç¼–è¯‘é”™è¯¯

**é”™è¯¯ä¿¡æ¯**:
```
error: feature 'confers' is not enabled
```

**è§£å†³æ–¹æ¡ˆ**:
ç¡®ä¿åœ¨ `Cargo.toml` ä¸­å¯ç”¨äº†æ‰€éœ€ç‰¹æ€§ï¼š

```toml
[dependencies]
inklog = { version = "0.1", features = ["confers", "aws", "http"] }
```

### parquet ä¾èµ–é—®é¢˜

**é”™è¯¯ä¿¡æ¯**:
```
error: failed to select a version for `parquet`
```

**è§£å†³æ–¹æ¡ˆ**:
æ›´æ–°åˆ°å…¼å®¹ç‰ˆæœ¬ï¼š

```toml
[dependencies]
parquet = { version = "50.0", features = ["async"] }
arrow-array = "50.0"
arrow-schema = "50.0"
```

---

## é…ç½®é—®é¢˜

### é…ç½®æ–‡ä»¶ä¸ç”Ÿæ•ˆ

**ç—‡çŠ¶**: ä½¿ç”¨é»˜è®¤é…ç½®è€Œéé…ç½®æ–‡ä»¶è®¾ç½®

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥é…ç½®æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤å¯ç”¨äº† `confers` ç‰¹æ€§
3. éªŒè¯ TOML è¯­æ³•

```bash
# éªŒè¯é…ç½®æ–‡ä»¶è¯­æ³•
inklog validate -c inklog.toml
```

**ç¤ºä¾‹æ­£ç¡®é…ç½®**:
```toml
[global]
level = "info"

[console_sink]
enabled = true
```

### ç¯å¢ƒå˜é‡ä¸è¦†ç›–é…ç½®

**ç—‡çŠ¶**: ç¯å¢ƒå˜é‡è®¾ç½®åæœªç”Ÿæ•ˆ

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥ç¯å¢ƒå˜é‡åç§°æ˜¯å¦æ­£ç¡®ï¼ˆå¿…é¡»ä½¿ç”¨ `INKLOG_*` å‰ç¼€ï¼‰
2. ç¡®è®¤åœ¨ç¨‹åºè¿è¡Œæ—¶ç¯å¢ƒå˜é‡å·²è®¾ç½®
3. æ£€æŸ¥æ˜¯å¦æœ‰æ‹¼å†™é”™è¯¯

```bash
# æ£€æŸ¥ç¯å¢ƒå˜é‡
echo $INKLOG_GLOBAL_LEVEL

# æµ‹è¯•ä¸´æ—¶è®¾ç½®
INKLOG_GLOBAL_LEVEL=debug cargo run
```

### æ— æ•ˆçš„æ—¥å¿—çº§åˆ«

**é”™è¯¯ä¿¡æ¯**:
```
Invalid log level: invalid_level
```

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨æœ‰æ•ˆçš„æ—¥å¿—çº§åˆ«ï¼š`trace`, `debug`, `info`, `warn`, `error`

### æ–‡ä»¶è·¯å¾„ä¸å­˜åœ¨

**é”™è¯¯ä¿¡æ¯**:
```
Cannot create directory: ...
```

**è§£å†³æ–¹æ¡ˆ**: ç¡®ä¿çˆ¶ç›®å½•å­˜åœ¨æˆ–ä½¿ç”¨ç»å¯¹è·¯å¾„

```toml
[file_sink]
path = "/var/log/myapp/app.log"
```

---

## è¿è¡Œæ—¶é—®é¢˜

### æ—¥å¿—ä¸è¾“å‡º

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥æ—¥å¿—çº§åˆ«è®¾ç½®
2. ç¡®è®¤è‡³å°‘ä¸€ä¸ª Sink å·²å¯ç”¨
3. æŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯æ—¥å¿—

```rust
// è°ƒè¯•æ¨¡å¼æŸ¥çœ‹å†…éƒ¨é”™è¯¯
env_logger::init();

// æ£€æŸ¥é…ç½®
let config = InklogConfig::default();
println!("Console enabled: {:?}", config.console_sink);
```

### Channel é˜»å¡

**ç—‡çŠ¶**: åº”ç”¨åœæ­¢å“åº”ï¼Œæ—¥å¿—å‘é€å¡ä½

**åŸå› **: Channel å·²æ»¡ï¼ŒèƒŒå‹æœºåˆ¶è§¦å‘

**è§£å†³æ–¹æ¡ˆ**:
```toml
[performance]
channel_capacity = 20000  # å¢åŠ å®¹é‡
```

æˆ–æ£€æŸ¥æ˜¯å¦æœ‰æ…¢ Sink é˜»å¡äº†å¤„ç†ã€‚

### ä¼˜é›…å…³é—­å¤±è´¥

**ç—‡çŠ¶**: å…³é—­æ—¶ä¸¢å¤±æ—¥å¿—

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥å…³é—­è¶…æ—¶è®¾ç½®
2. ç¡®è®¤æ‰€æœ‰ Sink æ­£å¸¸ flush

```rust
// å¢åŠ å…³é—­è¶…æ—¶
logger.shutdown(Duration::from_secs(60));
```

### HTTP ç«¯ç‚¹ä¸å¯ç”¨

**ç—‡çŠ¶**: è®¿é—® /health æˆ– /metrics è¿”å› 404

**æ’æŸ¥æ­¥éª¤**:
1. ç¡®è®¤å¯ç”¨äº† `http` ç‰¹æ€§
2. æ£€æŸ¥é…ç½®ä¸­ HTTP æœåŠ¡å™¨å·²å¯ç”¨

```toml
[http_server]
enabled = true
host = "0.0.0.0"
port = 8080
```

```bash
# æµ‹è¯•ç«¯ç‚¹
curl http://localhost:8080/health
curl http://localhost:8080/metrics
```

---

## æ€§èƒ½é—®é¢˜

### é«˜å†…å­˜å ç”¨

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥ Channel å®¹é‡æ˜¯å¦è¿‡å¤§
2. ç¡®è®¤æ²¡æœ‰æ—¥å¿—ç§¯å‹
3. æŸ¥çœ‹ Worker çº¿ç¨‹æ˜¯å¦æ­£å¸¸

```bash
# ç›‘æ§å†…å­˜ä½¿ç”¨
ps -o pid,rss,cmd -p $(pgrep -f inklog)
```

**è§£å†³æ–¹æ¡ˆ**:
```toml
[performance]
channel_capacity = 5000  # å‡å°‘å®¹é‡
```

### é«˜ CPU å ç”¨

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥æ—¥å¿—çº§åˆ«æ˜¯å¦è®¾ç½®è¿‡ä½ï¼ˆtrace/debugï¼‰
2. ç¡®è®¤å‹ç¼©/åŠ å¯†æ“ä½œæ­£å¸¸

**è§£å†³æ–¹æ¡ˆ**:
```toml
[global]
level = "info"  # æé«˜æ—¥å¿—çº§åˆ«
```

### å†™å…¥å»¶è¿Ÿè¿‡é«˜

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥ç›®æ ‡å­˜å‚¨æ€§èƒ½
2. ç¡®è®¤æ‰¹é‡å†™å…¥é…ç½®

**è§£å†³æ–¹æ¡ˆ**:
```toml
[database_sink]
batch_size = 200  # å¢åŠ æ‰¹é‡å¤§å°
flush_interval_ms = 1000  # å‡å°‘åˆ·æ–°é¢‘ç‡
```

---

## æ•°æ®åº“é—®é¢˜

### è¿æ¥å¤±è´¥

**é”™è¯¯ä¿¡æ¯**:
```
DatabaseError: connection refused
```

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥æ•°æ®åº“æœåŠ¡æ˜¯å¦è¿è¡Œ
2. éªŒè¯è¿æ¥ URL å’Œå‡­æ®
3. æ£€æŸ¥ç½‘ç»œè¿æ¥

```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
psql -h localhost -U user -d logs
```

**é™çº§è¡Œä¸º**: æ•°æ®åº“è¿æ¥å¤±è´¥æ—¶è‡ªåŠ¨é™çº§åˆ° File Sink

### æ‰¹é‡å†™å…¥å¤±è´¥

**é”™è¯¯ä¿¡æ¯**:
```
DatabaseError: batch insert failed
```

**è§£å†³æ–¹æ¡ˆ**:
1. å‡å°‘æ‰¹é‡å¤§å°
2. å¢åŠ è¶…æ—¶æ—¶é—´
3. æ£€æŸ¥æ•°æ®åº“è¿æ¥æ± é…ç½®

```toml
[database_sink]
batch_size = 50
flush_interval_ms = 1000
```

### åˆ†åŒºè¡¨æœªåˆ›å»º

**ç—‡çŠ¶**: æ—§æ•°æ®æŸ¥è¯¢æ…¢

**æ’æŸ¥æ­¥éª¤**:
1. ç¡®è®¤å¯ç”¨äº†åˆ†åŒºåŠŸèƒ½
2. æ£€æŸ¥ PostgreSQL ç‰ˆæœ¬ï¼ˆéœ€è¦ 12+ï¼‰

```sql
-- æ‰‹åŠ¨åˆ›å»ºåˆ†åŒº
CREATE TABLE logs_2024_01 PARTITION OF logs
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
```

### å½’æ¡£å¤±è´¥

**é”™è¯¯ä¿¡æ¯**:
```
Archive failed: S3 upload error
```

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥ AWS å‡­è¯
2. éªŒè¯ S3 å­˜å‚¨æ¡¶æƒé™
3. æ£€æŸ¥ç½‘ç»œè¿æ¥

---

## S3 å½’æ¡£é—®é¢˜

### ä¸Šä¼ å¤±è´¥

**æ’æŸ¥æ­¥éª¤**:
```bash
# éªŒè¯ AWS å‡­è¯
aws sts get-caller-identity

# æµ‹è¯• S3 è®¿é—®
aws s3 ls s3://your-bucket/
```

**é…ç½®æ£€æŸ¥**:
```toml
[archive]
bucket = "your-bucket"
region = "us-east-1"
access_key_id = "your-key"  # æˆ–ä½¿ç”¨ç¯å¢ƒå˜é‡
secret_access_key = "your-secret"
```

### å½’æ¡£æ ¼å¼

inklog ä½¿ç”¨ Parquet æ ¼å¼å½’æ¡£åˆ° S3ï¼Œæ–‡ä»¶å‘½åæ ¼å¼ï¼š

```
logs/YYYY/MM/logs_YYYYMMDD_HHMMSS_YYYYMMDD_HHMMSS_COUNT.parquet.zst
```

### å®šæ—¶ä»»åŠ¡ä¸æ‰§è¡Œ

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥ schedule_expression æ ¼å¼
2. ç¡®è®¤ ArchiveService å·²å¯åŠ¨
3. æŸ¥çœ‹è°ƒåº¦å™¨æ—¥å¿—

```toml
[archive]
schedule_expression = "0 2 * * *"  # Cron æ ¼å¼
```

### æœ¬åœ°ä¿ç•™ä¸æ¸…ç†

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥ local_retention_days è®¾ç½®
2. ç¡®è®¤ cleanup ä»»åŠ¡æ­£å¸¸è¿è¡Œ

```toml
[archive]
local_retention_days = 7
local_retention_path = "logs/archive_failures"
```

---

## åŠ å¯†é—®é¢˜

### åŠ å¯†å¯†é’¥é”™è¯¯

**é”™è¯¯ä¿¡æ¯**:
```
Encryption failed: invalid key length
```

**è§£å†³æ–¹æ¡ˆ**:
å¯†é’¥å¿…é¡»ä¸º Base64 ç¼–ç çš„ 32 å­—èŠ‚ï¼š

```bash
# ç”Ÿæˆæœ‰æ•ˆå¯†é’¥
openssl rand -base64 32
```

```toml
[file_sink]
encryption_key_env = "LOG_ENCRYPTION_KEY"
```

```bash
export LOG_ENCRYPTION_KEY="your-base64-key"
```

### è§£å¯†å¤±è´¥

**é”™è¯¯ä¿¡æ¯**:
```
Decryption failed: authentication tag mismatch
```

**æ’æŸ¥æ­¥éª¤**:
1. ç¡®è®¤ä½¿ç”¨æ­£ç¡®çš„å¯†é’¥
2. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å®Œæ•´

```bash
# ä½¿ç”¨ CLI å·¥å…·è§£å¯†
inklog-cli decrypt --input logs/app.log.enc --output decrypted.log
```

### åŠ å¯†æ–‡ä»¶æ ¼å¼

inklog åŠ å¯†æ–‡ä»¶æ ¼å¼ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Magic Header (8 bytes): "ENCLOG1\0"     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Version (2 bytes): 0x0001               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Algorithm ID (2 bytes): 0x0001 (AES-CM) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Nonce (12 bytes): Random per file       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Encrypted Data: AES-256-GCM ciphertext  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Auth Tag (16 bytes): GCM auth tag       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ—¥å¿—æ¢å¤

### ä»åŠ å¯†æ–‡ä»¶æ¢å¤

```bash
# è§£å¯†å•ä¸ªæ–‡ä»¶
inklog-cli decrypt -i encrypted.log.enc -o recovered.log

# è§£å¯†ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶
inklog-cli decrypt -i ./logs/ -o ./recovered/

# æ‰¹é‡è§£å¯†å¹¶è§£å‹ç¼©
inklog-cli decrypt -i ./logs/ --decompress -o ./recovered/
```

### ä»æŸåçš„ Channel æ¢å¤

å¦‚æœç¨‹åºå¼‚å¸¸ç»ˆæ­¢ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨æ¢å¤ï¼š

```rust
// å¯ç”¨æŒä¹…åŒ–æ¨¡å¼
let _logger = LoggerManager::builder()
    .enable_file("logs/recovery.log")
    .build()
    .await?;
```

### æ•°æ®åº“æ¢å¤

```sql
-- æ¢å¤è¯¯åˆ çš„æ—¥å¿—
INSERT INTO logs SELECT * FROM logs_backup WHERE ...

-- æ¢å¤åˆ†åŒºæ•°æ®
ALTER TABLE logs ATTACH PARTITION logs_2024_01
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
```

---

## è°ƒè¯•æ¨¡å¼

### å¯ç”¨è¯¦ç»†æ—¥å¿—

```bash
RUST_LOG=inklog=debug cargo run
```

### å†…éƒ¨æŒ‡æ ‡ç›‘æ§

è®¿é—® HTTP ç«¯ç‚¹æŸ¥çœ‹å†…éƒ¨çŠ¶æ€ï¼š

```bash
curl http://localhost:8080/health | jq
```

å…³é”®æŒ‡æ ‡ï¼š
- `channel_usage`: Channel ä½¿ç”¨ç‡
- `logs_written_total`: å·²å†™å…¥æ—¥å¿—æ•°
- `logs_dropped_total`: ä¸¢å¼ƒæ—¥å¿—æ•°
- `sink_errors_total`: Sink é”™è¯¯æ•°

### æ€§èƒ½åˆ†æ

```bash
# CPU æ€§èƒ½åˆ†æ
cargo flamegraph --bin your_app

# å†…å­˜åˆ†æ
valgrind --leak-check=full ./your_app
```

---

## å¸¸è§é—®é¢˜ FAQ

**Q: å¦‚ä½•å‡å°‘ç£ç›˜ IOï¼Ÿ**
A: å¯ç”¨å‹ç¼©ã€å¢åŠ æ‰¹é‡å¤§å°ã€å‡å°‘ flush é¢‘ç‡

**Q: å¦‚ä½•åœ¨å®¹å™¨ç¯å¢ƒä¸­ä½¿ç”¨ï¼Ÿ**
A: ç¡®ä¿æ­£ç¡®é…ç½®è·¯å¾„å’Œæƒé™ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®

**Q: å¦‚ä½•è¿ç§»åˆ° inklogï¼Ÿ**
A: é€æ­¥æ›¿æ¢ï¼Œä¿æŒæ—§ç³»ç»Ÿå¤‡ä»½ï¼ŒéªŒè¯æ•°æ®å®Œæ•´æ€§

**Q: æ”¯æŒå¤šå®ä¾‹å—ï¼Ÿ**
A: æ¯ä¸ªè¿›ç¨‹æ”¯æŒä¸€ä¸ª LoggerManager å®ä¾‹ï¼Œå¤šè¿›ç¨‹éœ€ç‹¬ç«‹é…ç½®

---

## è·å–å¸®åŠ©

- æŸ¥çœ‹å®Œæ•´æ–‡æ¡£: [docs/](docs/)
- æŸ¥çœ‹ç¤ºä¾‹ä»£ç : [examples/](examples/)
- æäº¤ Issue: GitHub Issues
