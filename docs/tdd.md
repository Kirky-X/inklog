# ğŸ”§ TDD - inklog æŠ€æœ¯è®¾è®¡æ–‡æ¡£ (Technical Design Document)

## 1. ç³»ç»Ÿæ¶æ„

### 1.1 é¡¹ç›®ç®€ä»‹ - âœ… å·²å®ç°

inklog æ˜¯ä¸€ä¸ªä¼ä¸šçº§Rustæ—¥å¿—åŸºç¡€è®¾æ–½ï¼Œæä¾›é«˜æ€§èƒ½ã€é«˜å¯é ã€å¯æ‰©å±•çš„æ—¥å¿—è®°å½•èƒ½åŠ›ã€‚æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº† inklog çš„æŠ€æœ¯è®¾è®¡æ–¹æ¡ˆã€‚

## ã€ç³»ç»Ÿæ¶æ„ - æ€»ä½“æ¶æ„å›¾ã€‘
**çŠ¶æ€**ï¼šâœ… å·²å®ç°
**å®ç°æ–‡ä»¶**ï¼šsrc/manager.rs, src/subscriber.rs, src/sink/
**æ£€æŸ¥ç»“æœ**ï¼š
- Application Layerï¼štracingå®é›†æˆå®Œæ•´
- Tracing Subscriber Layerï¼šLoggerSubscriberå®ç°å®Œæ•´
- Fast/Slow Pathåˆ†ç¦»ï¼šConsoleåŒæ­¥+å¼‚æ­¥Channelæ¶æ„
- Worker Thread Poolï¼š3çº¿ç¨‹æ¶æ„ï¼ˆDispatcher+File+DBï¼‰
- æ‰€æœ‰Sinkè¾“å‡ºé€šé“å®ç°å®Œæ•´

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼šæ— 

## ã€ç³»ç»Ÿæ¶æ„ - LoggerManagerå¼‚æ­¥æ¶æ„ã€‘
**çŠ¶æ€**ï¼šâš ï¸ éƒ¨åˆ†å®ç°
**å®ç°æ–‡ä»¶**ï¼šsrc/manager.rs
**æ£€æŸ¥ç»“æœ**ï¼š
- æ‰€æœ‰åˆå§‹åŒ–æ–¹æ³•å‡ä¸ºasync fnå·²å®ç°
- tokio runtimeç®¡ç†å¼‚æ­¥ä»»åŠ¡å·²å®ç°
- **é—®é¢˜**ï¼šHTTPæœåŠ¡å™¨å¼‚æ­¥å¯åŠ¨å­˜åœ¨é…ç½®é›†æˆé—®é¢˜
- **é—®é¢˜**ï¼šS3å½’æ¡£æœåŠ¡å¼‚æ­¥å¯åŠ¨é€»è¾‘ä¸å®Œæ•´
- å¼‚æ­¥Builderæ¨¡å¼å®ç°åŸºæœ¬å®Œæ•´

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼š
- ä¿®å¤HTTPæœåŠ¡å™¨å¼‚æ­¥å¯åŠ¨é…ç½®é›†æˆ
- å®Œå–„S3å½’æ¡£æœåŠ¡å¼‚æ­¥å¯åŠ¨é€»è¾‘

## ã€ç³»ç»Ÿæ¶æ„ - LogSink Traitè®¾è®¡ã€‘
**çŠ¶æ€**ï¼šâœ… å·²å®ç°
**å®ç°æ–‡ä»¶**ï¼šsrc/sink/mod.rs
**æ£€æŸ¥ç»“æœ**ï¼š
- LogSink traitå®šä¹‰å®Œæ•´ï¼ˆwrite/flush/is_healthy/shutdownï¼‰
- LogRecordç»“æ„ä½“æ”¯æŒæ‰€æœ‰å¿…è¦å­—æ®µ
- æ‰€æœ‰Sinkï¼ˆConsole/File/Databaseï¼‰å‡å®ç°trait
- traitè®¾è®¡æ”¯æŒå¹¶å‘å’Œé”™è¯¯å¤„ç†

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼šæ— 

**æ¶æ„è¯´æ˜**ï¼šinklog é‡‡ç”¨å¼‚æ­¥æ¶æ„è®¾è®¡ï¼Œæ‰€æœ‰åˆå§‹åŒ–æ–¹æ³•å‡ä¸º `async fn`ï¼Œå†…éƒ¨ä½¿ç”¨ tokio runtime ç®¡ç†å¼‚æ­¥ä»»åŠ¡ã€‚

```rust
// å®é™…å®ç°ç»“æ„
pub struct LoggerManager {
    #[allow(dead_code)]
    config: InklogConfig,
    #[allow(dead_code)]
    sender: Sender<LogRecord>,
    shutdown_tx: Sender<()>,
    #[allow(dead_code)]
    console_sink: Arc<Mutex<ConsoleSink>>,
    #[allow(dead_code)]
    metrics: Arc<Metrics>,
    worker_handles: Mutex<Vec<JoinHandle<()>>>,
    control_tx: Sender<SinkControlMessage>,
    #[cfg(feature = "aws")]
    archive_service: Option<Arc<tokio::sync::Mutex<ArchiveService>>>,
    #[cfg(feature = "http")]
    http_server_handle: Mutex<Option<tokio::task::JoinHandle<()>>>,
}

impl LoggerManager {
    /// ç›´æ¥åˆå§‹åŒ–ï¼ˆé›¶ä¾èµ–é»˜è®¤æ–¹å¼ï¼‰
    /// å¼‚æ­¥åˆå§‹åŒ–ï¼Œä½¿ç”¨é»˜è®¤é…ç½®
    pub async fn new() -> Result<Self, InklogError> {
        Self::with_config(InklogConfig::default()).await
    }
    
    /// ä½¿ç”¨æŒ‡å®šé…ç½®åˆå§‹åŒ–
    pub async fn with_config(config: InklogConfig) -> Result<Self, InklogError> {
        // 1. æ„å»º detached managerï¼ˆä¸æ³¨å†Œå…¨å±€ subscriberï¼‰
        let (manager, subscriber, filter) = Self::build_detached(config.clone()).await?;
        
        // 2. æ³¨å†Œå…¨å±€ tracing subscriber
        let registry = tracing_subscriber::registry().with(subscriber).with(filter);
        if let Err(_e) = registry.try_init() {
            // å…¨å±€ subscriber å·²å­˜åœ¨æ—¶çš„å¤„ç†
        }

        // 3. å¯åŠ¨ HTTP æœåŠ¡å™¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        #[cfg(feature = "http")]
        if let Some(ref http_cfg) = config.http_server {
            if http_cfg.enabled {
                manager.start_http_server(http_cfg).await?;
            }
        }

        Ok(manager)
    }
    
    /// æ–‡ä»¶åˆå§‹åŒ–ï¼ˆéœ€confersç‰¹æ€§ï¼‰
    /// å¼‚æ­¥ä»é…ç½®æ–‡ä»¶åŠ è½½é…ç½®
    #[cfg(feature = "confers")]
    pub async fn from_file<P: AsRef<Path>>(path: P) -> Result<Self, InklogError> {
        let config = InklogConfig::from_file(path)?;
        Self::with_config(config).await
    }
    
    /// è‡ªåŠ¨åŠ è½½é…ç½®ï¼ˆéœ€ confers ç‰¹æ€§ï¼‰
    #[cfg(feature = "confers")]
    pub async fn load() -> Result<Self, InklogError> {
        let config = InklogConfig::load()?;
        Self::with_config(config).await
    }
    
    /// Builderæ¨¡å¼ï¼ˆé›¶ä¾èµ–ï¼‰
    /// è¿”å›å¼‚æ­¥ Builder
    pub fn builder() -> LoggerBuilder {
        LoggerBuilder::default()
    }
    
    /// å¼‚æ­¥æ„å»ºå®Œæˆ
    pub async fn build(self) -> Result<LoggerManager, InklogError> {
        LoggerManager::with_config(self.config).await
    }
    
    /// å¯åŠ¨S3å½’æ¡£æœåŠ¡ï¼ˆå¼‚æ­¥ï¼‰
    #[cfg(feature = "aws")]
    pub async fn start_archive_service(&self) -> Result<(), InklogError> {
        // å¼‚æ­¥å¯åŠ¨å½’æ¡£æœåŠ¡
    }
    
    /// åœæ­¢S3å½’æ¡£æœåŠ¡ï¼ˆå¼‚æ­¥ï¼‰
    #[cfg(feature = "aws")]
    pub async fn stop_archive_service(&self) -> Result<(), InklogError> {
        // å¼‚æ­¥åœæ­¢å½’æ¡£æœåŠ¡
    }
}

/// å¼‚æ­¥ Builder å®ç°
impl LoggerBuilder {
    pub async fn build(self) -> Result<LoggerManager, InklogError> {
        LoggerManager::with_config(self.config).await
    }
}
```

**å¼‚æ­¥æ¶æ„ä¼˜åŠ¿**ï¼š
- **éé˜»å¡åˆå§‹åŒ–**ï¼šé…ç½®åŠ è½½ã€è¿æ¥å»ºç«‹ç­‰IOæ“ä½œä¸é˜»å¡ä¸»çº¿ç¨‹
- **å¹¶å‘å¤„ç†**ï¼šWorkerçº¿ç¨‹ä¸å¼‚æ­¥ä»»åŠ¡å¹¶å‘æ‰§è¡Œï¼Œæé«˜ååé‡
- **èµ„æºç®¡ç†**ï¼štokio runtime è‡ªåŠ¨ç®¡ç†å¼‚æ­¥ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸ
- **æ‰©å±•æ€§**ï¼šæ˜“äºé›†æˆå…¶ä»–å¼‚æ­¥ç»„ä»¶ï¼ˆå¦‚HTTPæœåŠ¡å™¨ã€S3å®¢æˆ·ç«¯ï¼‰

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```rust
#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    // é›¶ä¾èµ–é»˜è®¤åˆå§‹åŒ–
    let _logger = LoggerManager::new().await?;
    
    // æˆ–ä½¿ç”¨ Builder æ¨¡å¼
    let _logger = LoggerManager::builder()
        .level("debug")
        .enable_console(true)
        .enable_file("logs/app.log")
        .build()
        .await?;
    
    tracing::info!("Logger initialized successfully");
    Ok(())
}
```

#### 1.2.2 LogSink Trait

```rust
pub trait LogSink: Send {
    fn write(&mut self, record: &LogRecord) -> Result<(), SinkError>;
    fn flush(&mut self) -> Result<(), SinkError>;
    fn is_healthy(&self) -> bool;
    fn shutdown(&mut self) -> Result<(), SinkError>;
}

pub struct LogRecord {
    pub timestamp: DateTime<Utc>,
    pub level: Level,
    pub target: String,
    pub message: String,
    pub fields: HashMap<String, Value>,
    pub file: Option<String>,
    pub line: Option<u32>,
    pub thread_id: String,
}
```

## ã€å…³é”®æŠ€æœ¯é€‰å‹ - é…ç½®ç³»ç»Ÿã€‘
**çŠ¶æ€**ï¼šâš ï¸ éƒ¨åˆ†å®ç°
**å®ç°æ–‡ä»¶**ï¼šsrc/config.rs
**æ£€æŸ¥ç»“æœ**ï¼š
- åŒé‡åˆå§‹åŒ–ç­–ç•¥åŸºæœ¬å®ç°ï¼ˆé›¶ä¾èµ–+confersï¼‰
- TOMLæ ¼å¼é…ç½®æ–‡ä»¶æ”¯æŒå·²å®ç°
- **é—®é¢˜**ï¼šç¯å¢ƒå˜é‡è¦†ç›–æœºåˆ¶å­˜åœ¨ç¼ºé™·ï¼Œéƒ¨åˆ†é…ç½®é¡¹æ— æ³•æ­£ç¡®è¦†ç›–
- é…ç½®éªŒè¯é€»è¾‘åŸºæœ¬å®Œæ•´
- Builderæ¨¡å¼æ”¯æŒé“¾å¼é…ç½®

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼š
- ä¿®å¤ç¯å¢ƒå˜é‡è¦†ç›–æœºåˆ¶çš„ç¼ºé™·
- å®Œå–„é…ç½®éªŒè¯é€»è¾‘

## ã€å…³é”®æŠ€æœ¯é€‰å‹ - ä¾èµ–Crateæ¸…å•ã€‘
**çŠ¶æ€**ï¼šâœ… å·²å®ç°
**å®ç°æ–‡ä»¶**ï¼šCargo.toml
**æ£€æŸ¥ç»“æœ**ï¼š
- tracingç”Ÿæ€å®Œæ•´é›†æˆï¼ˆtracing + tracing-subscriberï¼‰
- crossbeam-channelé«˜æ€§èƒ½æ¶ˆæ¯ä¼ é€’
- owo-colorså½©è‰²è¾“å‡ºæ”¯æŒ
- serde/tomlé…ç½®è§£æï¼ˆconfersç‰¹æ€§ï¼‰
- zstdå‹ç¼©å’Œaes-gcmåŠ å¯†
- sea-ormæ•°æ®åº“æŠ½è±¡
- aws-sdk-s3äº‘å­˜å‚¨æ”¯æŒ

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼šæ— 

## ã€ADR-001 - crossbeam-channelé€‰å‹ã€‘
**çŠ¶æ€**ï¼šâœ… å·²å®ç°
**å®ç°æ–‡ä»¶**ï¼šsrc/manager.rs
**æ£€æŸ¥ç»“æœ**ï¼š
- ç¡®å®ä½¿ç”¨crossbeam-channelå®ç°æ—¥å¿—åˆ†å‘
- ç¬¦åˆæ€§èƒ½å’Œæ¶æ„è€ƒé‡
- Workerä½¿ç”¨OSçº¿ç¨‹è€Œéasyncä»»åŠ¡
- é›¶åˆ†é…bounded channelä¼˜åŒ–

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼šæ— 

## ã€ADR-002 - 3çº¿ç¨‹æ¶æ„å†³ç­–ã€‘
**çŠ¶æ€**ï¼šâœ… å·²å®ç°
**å®ç°æ–‡ä»¶**ï¼šsrc/manager.rs
**æ£€æŸ¥ç»“æœ**ï¼š
- Dispatcherçº¿ç¨‹è´Ÿè´£æ—¥å¿—æ¥æ”¶å’Œåˆ†å‘
- File Workerçº¿ç¨‹å¤„ç†æ–‡ä»¶å†™å…¥ã€è½®è½¬ç­‰æ“ä½œ
- DB Workerçº¿ç¨‹å¤„ç†æ•°æ®åº“æ‰¹é‡å†™å…¥å’ŒS3å½’æ¡£
- å„çº¿ç¨‹èŒè´£åˆ†ç¦»ï¼Œç¬¦åˆæ¶æ„è®¾è®¡è¦æ±‚

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼šæ— 

## ã€ADR-003 - åŒé‡åˆå§‹åŒ–ç­–ç•¥ã€‘
**çŠ¶æ€**ï¼šâœ… å·²å®ç°
**å®ç°æ–‡ä»¶**ï¼šsrc/manager.rs, src/config.rs
**æ£€æŸ¥ç»“æœ**ï¼š
- LoggerManager::new()æ”¯æŒç›´æ¥åˆå§‹åŒ–
- LoggerBuilderæ¨¡å¼æ”¯æŒé›¶ä¾èµ–é…ç½®æ„å»º
- confersç‰¹æ€§æ”¯æŒæ–‡ä»¶åˆå§‹åŒ–åŠŸèƒ½
- APIä¿æŒä¸€è‡´ï¼Œåˆ‡æ¢é€æ˜

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼šæ— 

## ã€ADR-004 - AES-GCMåŠ å¯†ç®—æ³•é€‰æ‹©ã€‘
**çŠ¶æ€**ï¼šâœ… å·²å®ç°
**å®ç°æ–‡ä»¶**ï¼šsrc/sink/file.rs, src/archive.rs
**æ£€æŸ¥ç»“æœ**ï¼š
- AES-256-GCMæ—¥å¿—æ–‡ä»¶åŠ å¯†åŠŸèƒ½å®Œæ•´
- æ”¯æŒå¯†é’¥ä»ç¯å¢ƒå˜é‡è¯»å–ï¼ˆBase64ç¼–ç ï¼‰
- æ¯ä¸ªæ—¥å¿—æ–‡ä»¶ä½¿ç”¨éšæœºNonceç¡®ä¿å®‰å…¨
- æ–‡ä»¶å¤´å­˜å‚¨åŠ å¯†å…ƒæ•°æ®ï¼Œç¬¦åˆAEADè¦æ±‚

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼šæ— 

---

## 3. æ ¸å¿ƒæµç¨‹è®¾è®¡

## ã€æ ¸å¿ƒæµç¨‹è®¾è®¡ - æ—¥å¿—å†™å…¥æµç¨‹ã€‘
**çŠ¶æ€**ï¼šâœ… å·²å®ç°
**å®ç°æ–‡ä»¶**ï¼šsrc/subscriber.rs, src/manager.rs, src/sink/
**æ£€æŸ¥ç»“æœ**ï¼š
- åº”ç”¨ä»£ç â†’tracingå®â†’Eventç”Ÿæˆæµç¨‹å®Œæ•´
- Subscriberæ‹¦æˆªEventå¹¶è½¬æ¢ä¸ºLogRecord
- Console SinkåŒæ­¥writeè·¯å¾„ï¼ˆ<50Î¼sï¼‰
- Async Channelå¼‚æ­¥sendè·¯å¾„ï¼ˆ<5Î¼sï¼‰
- Workerçº¿ç¨‹å¤„ç†Fileå’ŒDBå†™å…¥

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼šæ— 

## ã€æ ¸å¿ƒæµç¨‹è®¾è®¡ - æ–‡ä»¶è½®è½¬æµç¨‹ã€‘
**çŠ¶æ€**ï¼šâœ… å·²å®ç°
**å®ç°æ–‡ä»¶**ï¼šsrc/sink/file.rs
**æ£€æŸ¥ç»“æœ**ï¼š
- å¤§å°æ£€æµ‹ï¼ˆæ¯100æ¡æ£€æŸ¥ä¸€æ¬¡ï¼‰å·²å®ç°
- æ—¶é—´è§¦å‘ï¼ˆåŸºäºchronoï¼‰å·²å®ç°
- æ–‡ä»¶é‡å‘½åï¼ˆåŸå­æ“ä½œï¼‰å·²å®Œæˆ
- å†å²æ–‡ä»¶æ¸…ç†å·²å®ç°
- å¼‚æ­¥å‹ç¼©+åŠ å¯†åå°å¤„ç†

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼šæ— 

## ã€æ ¸å¿ƒæµç¨‹è®¾è®¡ - æ•°æ®åº“æ‰¹é‡å†™å…¥æµç¨‹ã€‘
**çŠ¶æ€**ï¼šâœ… å·²å®ç°
**å®ç°æ–‡ä»¶**ï¼šsrc/sink/database.rs
**æ£€æŸ¥ç»“æœ**ï¼š
- ç¼“å†²åŒºç®¡ç†å’Œæ‰¹é‡å¤§å°æ§åˆ¶
- è¶…æ—¶åˆ·æ–°æœºåˆ¶ï¼ˆ500msé»˜è®¤ï¼‰
- æ‰¹é‡INSERT SQLç”Ÿæˆ
- äº‹åŠ¡æ§åˆ¶å’Œé”™è¯¯å¤„ç†
- åˆ†åŒºè¡¨è‡ªåŠ¨åˆ›å»º

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼šæ— 

## ã€æ ¸å¿ƒæµç¨‹è®¾è®¡ - S3å½’æ¡£æµç¨‹ã€‘
**çŠ¶æ€**ï¼šâš ï¸ éƒ¨åˆ†å®ç°
**å®ç°æ–‡ä»¶**ï¼šsrc/archive/
**æ£€æŸ¥ç»“æœ**ï¼š
- å®šæ—¶ä»»åŠ¡ï¼ˆæ¯æ—¥å‡Œæ™¨2ç‚¹æ£€æŸ¥ï¼‰åŸºæœ¬å®ç°
- æ•°æ®åº“æŸ¥è¯¢é…ç½®å¤©æ•°å‰çš„æ—¥å¿—å·²å®ç°
- S3ä¸Šä¼ åŠŸèƒ½å·²å®ç°
- **é—®é¢˜**ï¼šå½’æ¡£æ ¼å¼ä¸ºJSONï¼Œæœªå®ç°Parquetå¯¼å‡º
- **é—®é¢˜**ï¼šå½’æ¡£å…ƒæ•°æ®è®°å½•ä¸å®Œæ•´
- **é—®é¢˜**ï¼šå®šæ—¶ä»»åŠ¡è°ƒåº¦å­˜åœ¨ç¨³å®šæ€§é—®é¢˜

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼š
- å®ç°Parquetæ ¼å¼å¯¼å‡ºæ›¿ä»£JSON
- å®Œå–„å½’æ¡£å…ƒæ•°æ®è®°å½•åŠŸèƒ½
- ä¿®å¤å®šæ—¶ä»»åŠ¡è°ƒåº¦ç¨³å®šæ€§é—®é¢˜

------

## 4. æ•°æ®æ¨¡å‹è®¾è®¡

## ã€æ•°æ®æ¨¡å‹è®¾è®¡ - æ•°æ®åº“è¡¨ç»“æ„ã€‘
**çŠ¶æ€**ï¼šâœ… å·²å®ç°
**å®ç°æ–‡ä»¶**ï¼šsrc/sink/database.rs
**æ£€æŸ¥ç»“æœ**ï¼š
- ä¸»æ—¥å¿—è¡¨ç»“æ„å®Œæ•´ï¼ˆid/timestamp/level/target/message/fieldsç­‰ï¼‰
- æŒ‰æœˆåˆ†åŒºè¡¨è‡ªåŠ¨åˆ›å»ºï¼ˆPostgreSQLï¼‰
- å½’æ¡£å…ƒæ•°æ®è¡¨å·²å®ç°
- ç´¢å¼•ä¼˜åŒ–ï¼ˆæ—¶é—´æˆ³é™åºã€çº§åˆ«ã€ç›®æ ‡æ¨¡å—ï¼‰
- SeaORM Entityè‡ªåŠ¨æ˜ å°„

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼šæ— 

## ã€æ•°æ®æ¨¡å‹è®¾è®¡ - é…ç½®æ•°æ®ç»“æ„ã€‘
**çŠ¶æ€**ï¼šâœ… å·²å®ç°
**å®ç°æ–‡ä»¶**ï¼šsrc/config.rs
**æ£€æŸ¥ç»“æœ**ï¼š
- InklogConfigä¸»é…ç½®ç»“æ„å®Œæ•´
- GlobalConfig/ConsoleSinkConfig/FileSinkConfig/DatabaseSinkConfigé½å…¨
- serdeåºåˆ—åŒ–/ååºåˆ—åŒ–æ”¯æŒ
- é»˜è®¤å€¼å’ŒéªŒè¯é€»è¾‘å®Œæ•´
- ç¯å¢ƒå˜é‡è¦†ç›–æœºåˆ¶

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼šæ— 

## ã€å®‰å…¨è®¾è®¡ - åŠ å¯†æµç¨‹ã€‘
**çŠ¶æ€**ï¼šâœ… å·²å®ç°
**å®ç°æ–‡ä»¶**ï¼šsrc/sink/file.rs
**æ£€æŸ¥ç»“æœ**ï¼š
- AES-256-GCMåŠ å¯†ç®—æ³•å®ç°å®Œæ•´
- ç¯å¢ƒå˜é‡å¯†é’¥ç®¡ç†ï¼ˆBase64ç¼–ç 32å­—èŠ‚ï¼‰
- æ¯æ–‡ä»¶ç‹¬ç«‹éšæœºNonce
- 24å­—èŠ‚Headeræ ¼å¼è§„èŒƒå®ç°
- åŠ å¯†å¤±è´¥æ—¶å®‰å…¨é™çº§æœºåˆ¶

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼šæ— 

## ã€å®‰å…¨è®¾è®¡ - æƒé™æ§åˆ¶ã€‘
**çŠ¶æ€**ï¼šâœ… å·²å®ç°
**å®ç°æ–‡ä»¶**ï¼šsrc/sink/file.rs, src/sink/database.rs
**æ£€æŸ¥ç»“æœ**ï¼š
- æ—¥å¿—æ–‡ä»¶æƒé™600ï¼ˆä»…æ‰€æœ‰è€…è¯»å†™ï¼‰
- é…ç½®æ–‡ä»¶æƒé™600
- å½’æ¡£æ–‡ä»¶æƒé™400ï¼ˆåªè¯»é˜²ç¯¡æ”¹ï¼‰
- æ•°æ®åº“æƒé™æ§åˆ¶ï¼ˆINSERT/SELECTï¼Œç¦æ­¢UPDATEï¼‰
- S3æƒé™ç­–ç•¥ï¼ˆs3:PutObject + SSE-S3åŠ å¯†ï¼‰

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼šæ— 

**åŠ å¯†æ–‡ä»¶æ ¼å¼ä»£ç ç¤ºä¾‹**ï¼š

```rust
const MAGIC: &[u8] = b"ENCLOG1\0";
const VERSION: u16 = 1;
const ALGO_AES_GCM: u16 = 1;

fn write_encrypted_file(data: &[u8], key: &[u8; 32]) -> Result<()> {
    let mut file = File::create("app.log.enc")?;
    
    // 1. Header
    file.write_all(MAGIC)?;
    file.write_all(&VERSION.to_le_bytes())?;
    file.write_all(&ALGO_AES_GCM.to_le_bytes())?;
    
    // 2. Nonce
    let nonce: [u8; 12] = rand::random();
    file.write_all(&nonce)?;
    
    // 3. Encrypt
    let cipher = Aes256Gcm::new(key.into());
    let ciphertext = cipher.encrypt(nonce.as_ref().into(), data)?;
    file.write_all(&ciphertext)?;
    
    Ok(())
}
```

------

## 6. è¿ç§»æŒ‡å—

### 6.1 ç‰ˆæœ¬å¯¹æ¯” - âœ… å·²å®ç°

## 7. ä»£ç è´¨é‡è¯„ä¼°

### 7.1 è¯„ä¼°æ–¹æ³•è®º

ä»£ç è´¨é‡è¯„ä¼°åŸºäºä»¥ä¸‹ç»´åº¦ï¼š
- **ä»£ç ç¼ºé™·**ï¼šç©ºæŒ‡é’ˆè§£å¼•ç”¨ã€å†…å­˜æ³„æ¼ã€èµ„æºæœªé‡Šæ”¾ã€é€»è¾‘é”™è¯¯
- **æ€§èƒ½éšæ‚£**ï¼šä¸å¿…è¦çš„å†…å­˜åˆ†é…ã€é”ç«äº‰ã€ç®—æ³•å¤æ‚åº¦
- **å®‰å…¨é£é™©**ï¼šæœªåˆå§‹åŒ–å†…å­˜ã€æ³¨å…¥æ¼æ´ã€æ•æ„Ÿä¿¡æ¯æ³„éœ²
- **æœ€ä½³å®è·µ**ï¼šæ–‡æ¡£å®Œæ•´æ€§ã€é”™è¯¯å¤„ç†ã€æµ‹è¯•è¦†ç›–

### 7.2 è¯„ä¼°ç»“æœ

#### 7.2.1 ä¸¥é‡é—®é¢˜ï¼ˆéœ€ç«‹å³ä¿®å¤ï¼‰

| é—®é¢˜ | æ–‡ä»¶ä½ç½® | ä¸¥é‡ç¨‹åº¦ | æè¿° |
|------|----------|----------|------|
| æ— ä¸¥é‡é—®é¢˜ | å…¨é¡¹ç›® | âœ… å·²ä¿®å¤ | ä¹‹å‰æŠ¥å‘Šçš„unsafeä»£ç é—®é¢˜å·²ä¸å­˜åœ¨ |

#### 7.2.2 ä¸­ç­‰é—®é¢˜ï¼ˆå»ºè®®æ”¹è¿›ï¼‰

| é—®é¢˜ | æ–‡ä»¶ä½ç½® | ä¸¥é‡ç¨‹åº¦ | æè¿° |
|------|----------|----------|------|
| è¿‡å¤šunwrap | `src/sink/file.rs` (~32å¤„) | ğŸŸ¡ ä¸­ç­‰ | æ—¶é—´è§£æã€è·¯å¾„æ“ä½œç­‰ä½¿ç”¨ `unwrap()`ï¼Œå»ºè®®æ”¹ç”¨ `?` æˆ– `expect()` å¹¶é™„å¸¦é”™è¯¯ä¿¡æ¯ |
| è¿‡å¤šunwrap | `src/archive/service.rs` (~32å¤„) | ğŸŸ¡ ä¸­ç­‰ | S3æ“ä½œã€é…ç½®è§£æç­‰ä½¿ç”¨ `unwrap()`ï¼Œå­˜åœ¨panicé£é™© |
| è¿‡å¤šclone | `src/sink/database.rs:248-256` | ğŸŸ¡ ä¸­ç­‰ | LogRecord å­—æ®µåœ¨çƒ­è·¯å¾„ä¸­å¤§é‡ cloneï¼Œå»ºè®®ä½¿ç”¨å¼•ç”¨æˆ– `Cow<T>` |
| æ–‡æ¡£ä¸è¶³ | å…¨å±€ | ğŸŸ¡ ä¸­ç­‰ | ä»…çº¦ 16 å¤„ `///` æ ¼å¼æ–‡æ¡£æ³¨é‡Šï¼Œå…¬å…± API ç¼ºå°‘ç”¨æ³•ç¤ºä¾‹ |
| é”™è¯¯å¤„ç†ä¸å®Œæ•´ | å¤šä¸ªæ–‡ä»¶ | ğŸŸ¡ ä¸­ç­‰ | éƒ¨åˆ†é”™è¯¯åœºæ™¯ç¼ºå°‘è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼Œå½±å“è°ƒè¯• |

#### 7.2.3 è‰¯å¥½å®è·µ

| é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| å‘½åè§„èŒƒ | âœ… è‰¯å¥½ | snake_case å‡½æ•°ã€PascalCase ç±»å‹ï¼Œç¬¦åˆ Rust æƒ¯ä¾‹ |
| é”™è¯¯å¤„ç† | âœ… è‰¯å¥½ | ä½¿ç”¨ `thiserror` å®šä¹‰é”™è¯¯ç±»å‹ï¼Œéµå¾ª Rust é”™è¯¯å¤„ç†æœ€ä½³å®è·µ |
| æ¨¡å—åˆ’åˆ† | âœ… è‰¯å¥½ | èŒè´£åˆ†ç¦»æ¸…æ™°ï¼Œsink/config/archive ç­‰æ¨¡å—è¾¹ç•Œæ˜ç¡® |
| æŠ€æœ¯å€ºåŠ¡ | âœ… è‰¯å¥½ | æ—  TODO/FIXME æ ‡è®° |
| çº¿ç¨‹å®‰å…¨ | âœ… è‰¯å¥½ | æ­£ç¡®ä½¿ç”¨ `Arc<Mutex>` ä¿è¯å¹¶å‘å®‰å…¨ |

### 7.3 æ€»ä½“è¯„ä¼°

| ç»´åº¦ | çŠ¶æ€ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|------|
| åŠŸèƒ½å®Œæ•´æ€§ | âš ï¸ éƒ¨åˆ†å®ç° | 85% | PRD éœ€æ±‚è¦†ç›–ç‡è¾ƒé«˜ï¼Œä½†å­˜åœ¨å…³é”®åŠŸèƒ½ç¼ºé™· |
| æŠ€æœ¯ç¬¦åˆæ€§ | âš ï¸ éƒ¨åˆ†å®ç° | 80% | TDD æ¶æ„è®¾è®¡åŸºæœ¬è½åœ°ï¼Œä½†éƒ¨åˆ†å®ç°ä¸å®Œæ•´ |
| ä»£ç è´¨é‡ | âš ï¸ éƒ¨åˆ†å®ç° | 75% | ä»£ç è´¨é‡è‰¯å¥½ï¼Œä½†å­˜åœ¨è¿‡å¤šunwrapå’Œæ–‡æ¡£ä¸è¶³é—®é¢˜ |

**æ€»ä½“è¯„ä»·**ï¼šä»£ç æ•´ä½“è´¨é‡ä¸­ç­‰åä¸Šï¼Œæ ¸å¿ƒåŠŸèƒ½åŸºæœ¬å®ç°ã€‚å­˜åœ¨å¤šå¤„éœ€è¦æ”¹è¿›çš„ä¸­ç­‰é—®é¢˜ï¼Œä¸»è¦é›†ä¸­åœ¨é”™è¯¯å¤„ç†å’Œæ–‡æ¡£å®Œå–„æ–¹é¢ã€‚å»ºè®®åœ¨ä¸‹æ¬¡å‘ç‰ˆå‰è§£å†³è¿™äº›é—®é¢˜ã€‚

| åŠŸèƒ½ | æ—§ç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ï¼ˆé»˜è®¤ï¼‰ | æ–°ç‰ˆæœ¬ï¼ˆconfersï¼‰ |
|------|--------|---------------|------------------|
| é»˜è®¤é…ç½® | `init(None)` | `new()` | `load()` |
| æŒ‡å®šé…ç½®æ–‡ä»¶ | `init("config.toml")` | N/A | `from_file("config.toml")` |
| Builderæ¨¡å¼ | âœ… | âœ… | âœ… |
| é›¶ä¾èµ– | âœ… | âœ… | âœ… |
| é…ç½®æ–‡ä»¶æ”¯æŒ | âœ… | âŒ | âœ… |
| ç¯å¢ƒå˜é‡é…ç½® | âœ… | âŒ | âœ… |

### 6.2 è¿ç§»æ­¥éª¤ - âœ… å·²å®ç°

#### ä»æ—§ç‰ˆæœ¬è¿ç§»åˆ°é›¶ä¾èµ–ç‰ˆæœ¬

```rust
// æ—§ç‰ˆæœ¬
let logger = LoggerManager::init(None)?;

// æ–°ç‰ˆæœ¬ï¼ˆé›¶ä¾èµ–ï¼‰
let logger = LoggerManager::new()?;
```

#### ä»æ—§ç‰ˆæœ¬è¿ç§»åˆ°é…ç½®æ–‡ä»¶ç‰ˆæœ¬

```rust
// æ—§ç‰ˆæœ¬
let logger = LoggerManager::init("config.toml")?;

// æ–°ç‰ˆæœ¬ï¼ˆéœ€å¯ç”¨confersç‰¹æ€§ï¼‰
let logger = LoggerManager::from_file("config.toml")?;
```

#### ä½¿ç”¨Builderæ¨¡å¼

```rust
// æ–°ç‰ˆæœ¬æ”¯æŒé“¾å¼é…ç½®
let logger = LoggerManager::builder()
    .level("info")
    .enable_console(true)
    .enable_file("app.log")
    .max_file_size("100MB")
    .build()?;
```

### 6.3 ç‰¹æ€§é…ç½® - âœ… å·²å®ç°

åœ¨ `Cargo.toml` ä¸­é…ç½®ï¼š

```toml
[dependencies]
# é›¶ä¾èµ–ç‰ˆæœ¬ï¼ˆé»˜è®¤ï¼‰
inklog = "0.1"

# å¯ç”¨é…ç½®æ–‡ä»¶æ”¯æŒ
inklog = { version = "0.1", features = ["confers"] }
```

### 6.4 æ³¨æ„äº‹é¡¹ - âœ… å·²å®ç°

1. **é›¶ä¾èµ–ç‰ˆæœ¬**ä¸æ”¯æŒé…ç½®æ–‡ä»¶å’Œç¯å¢ƒå˜é‡é…ç½®
2. **confersç‰¹æ€§**ç‰ˆæœ¬å®Œå…¨å…¼å®¹æ—§ç‰ˆæœ¬çš„é…ç½®æ–‡ä»¶åŠŸèƒ½
3. **Builderæ¨¡å¼**åœ¨ä¸¤ä¸ªç‰ˆæœ¬ä¸­éƒ½å¯ä»¥ä½¿ç”¨
4. è¿ç§»åAPIæ›´åŠ æ¸…æ™°ï¼ŒåŒºåˆ†äº†é›¶ä¾èµ–å’Œé…ç½®æ–‡ä»¶ä¸¤ç§ä½¿ç”¨åœºæ™¯

## 7. ç›‘æ§ä¸å¯è§‚æµ‹æ€§

### 6.1 å†…éƒ¨æŒ‡æ ‡ - âœ… å·²å®ç°

**å®ç°çŠ¶æ€è¯´æ˜**ï¼š
- âœ… Metricsç»“æ„ä½“å·²åœ¨src/metrics.rsä¸­å®ç°
- âœ… åŸºæœ¬è®¡æ•°å™¨å·²å®ç° (logs_written_total, logs_dropped_total, channel_send_blocked_total, sink_errors_total)
- âœ… å»¶è¿Ÿç›´æ–¹å›¾å·²å®ç° (latency_histogram, total_latency_us)
- âœ… Sinkå¥åº·çŠ¶æ€å·²å®ç° (sink_health HashMap)
- âœ… ä¸subscriber.rsçš„é›†æˆå·²å®Œæˆ
- âœ… HTTPæ¥å£å·²åœ¨src/manager.rsä¸­å®ç° (metricså’Œhealthç«¯ç‚¹)
- âœ… Prometheusæ ¼å¼å¯¼å‡ºå·²æ”¯æŒ
- âœ… å®Œæ•´çš„å¥åº·æ£€æŸ¥HTTPç«¯ç‚¹å·²å®ç°

```rust
// å®é™…å®ç°çš„ç»“æ„ (src/metrics.rs)
pub struct Metrics {
    pub logs_written_total: AtomicU64,
    pub logs_dropped_total: AtomicU64,
    pub channel_send_blocked_total: AtomicU64,
    pub sink_errors_total: AtomicU64,
    pub total_latency_us: AtomicU64,
    pub latency_count: AtomicU64,
    pub latency_histogram: Histogram,
    pub active_workers: Gauge,
    pub sink_health: Mutex<HashMap<String, SinkHealth>>,
}
```

### 6.2 å¥åº·æ£€æŸ¥æ¥å£ - âœ… å·²å®ç°

```rust
// âœ… å·²åœ¨src/metrics.rsä¸­å®ç°
pub struct HealthStatus {
    pub overall: bool,
    pub sinks: HashMap<String, SinkHealth>,
    pub channel_usage: f64,
    pub uptime_seconds: u64,
    pub metrics: MetricsSnapshot,
}

// âœ… å·²åœ¨src/metrics.rsä¸­å®ç°
pub struct SinkHealth {
    pub healthy: bool,
    pub last_error: Option<String>,
    pub consecutive_failures: u32,
}

// âœ… å·²åœ¨src/manager.rsä¸­å®ç°
// æ–¹æ³•: LoggerManager::get_health_status() -> HealthStatus
// å¯é€šè¿‡ç¨‹åºå†…APIè·å–å¥åº·çŠ¶æ€

// âœ… å·²å®ç°: HTTPç«¯ç‚¹: GET /health
// âœ… å·²é›†æˆ: è½»é‡çº§HTTPæœåŠ¡å™¨
```

**å®ç°çŠ¶æ€è¯´æ˜**:
- âœ… HealthStatuså’ŒSinkHealthç»“æ„ä½“å·²åœ¨src/metrics.rsä¸­å®ç°
- âœ… LoggerManager::get_health_status()æ–¹æ³•å·²åœ¨src/manager.rsä¸­å®ç°
- âœ… LogSink traitçš„is_healthy()æ–¹æ³•å·²åœ¨æ‰€æœ‰sinkä¸­å®ç°
- âœ… æŒ‡æ ‡æ”¶é›†å’Œå¥åº·çŠ¶æ€æ›´æ–°å·²åœ¨manager.rsä¸­é›†æˆ
- âœ… HTTPæœåŠ¡å™¨å·²é›†æˆ
- âœ… GET /healthç«¯ç‚¹å·²æš´éœ²
```

---

## 7. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 7.1 å†…å­˜ä¼˜åŒ– - âœ… å·²å®ç° - å¯¹è±¡æ± å’Œé›¶æ‹·è´ä¼˜åŒ–å·²å®Œæˆ

```
[å¯¹è±¡æ± å¤ç”¨]
â”œâ”€ LogRecord Pool: å¤ç”¨å·²åˆ†é…çš„LogRecord
â”œâ”€ String Buffer Pool: å¤ç”¨æ ¼å¼åŒ–ç¼“å†²åŒº
â””â”€ æ‰¹é‡åˆ†é…: Vecé¢„åˆ†é…å®¹é‡

[é›¶æ‹·è´ä¼˜åŒ–]
â”œâ”€ Consoleè¾“å‡º: ç›´æ¥å†™å…¥BufWriter
â”œâ”€ Fileå†™å…¥: ä½¿ç”¨std::io::copy
â””â”€ é¿å…String::clone(): ä½¿ç”¨&strå¼•ç”¨
```

| ç‰¹æ€§         | æè¿°                                      | çŠ¶æ€      |
| :----------- | :---------------------------------------- | :-------- |
| å¼‚æ­¥å†™å…¥     | Bounded Channel + Backpressure Block      | âœ… å·²å®ç° |
| é”™è¯¯ä¼ æ’­     | å¼ºç±»å‹é”™è¯¯ + anyhow ä¸Šä¸‹æ–‡                | âœ… å·²å®ç° |
| æ–­è·¯å™¨       | åŸºäºé”™è¯¯è®¡æ•°çš„è‡ªåŠ¨ç†”æ–­ä¸æ¢å¤              | âœ… å·²å®Œæˆ |
| å¯¹è±¡æ±        | å¤ç”¨ LogRecord å’Œ String ç¼“å†²åŒº           | âœ… å·²å®ç° |

### 7.2 IOä¼˜åŒ– - âœ… å·²å®ç° - æ‰¹é‡å†™å…¥å’Œå¹¶è¡Œå¤„ç†å·²ä¼˜åŒ–
- âœ… å¹¶è¡Œå‹ç¼©å·²å®ç° (Rayon)
- âœ… S3 åˆ†ç‰‡ä¸Šä¼ å·²å®Œæˆ (Multipart Upload)

```
[æ‰¹é‡å†™å…¥]
â”œâ”€ æ•°æ®åº“: 100æ¡/æ‰¹æ¬¡
â”œâ”€ æ–‡ä»¶: ä½¿ç”¨BufWriter (8KBç¼“å†²)
â””â”€ S3å½’æ¡£: åˆ†ç‰‡ä¸Šä¼  (5MB/ç‰‡)

[å¹¶è¡Œå¤„ç†]
â”œâ”€ å‹ç¼©: rayonå¹¶è¡Œå‹ç¼©å¤šä¸ªæ–‡ä»¶
â”œâ”€ åŠ å¯†: å¤šçº¿ç¨‹AES-GCM
â””â”€ S3ä¸Šä¼ : å¹¶å‘ä¸Šä¼ å¤šä¸ªå½’æ¡£æ–‡ä»¶
```

---

## 8. æ•…éšœå¤„ç†

### 8.1 èƒŒå‹æ§åˆ¶æœºåˆ¶ - âœ… å·²å®ç°

```
// ä¼ªä»£ç ç¤ºä¾‹
let (sender, receiver) = bounded(10_000); // crossbeamæœ‰ç•Œé€šé“

// å‘é€ç«¯è¡Œä¸º
match sender.try_send(record) {
    Ok(_) => { /* æˆåŠŸå…¥é˜Ÿï¼Œ<5Î¼s */ }
    Err(TrySendError::Full(_)) => {
        // èƒŒå‹è§¦å‘ï¼šé˜»å¡ç­‰å¾…
        sender.send(record).unwrap(); // é˜»å¡ç›´åˆ°æœ‰ç©ºä½
        metrics.channel_send_blocked_total.inc();
    }
}
```

**èƒŒå‹ç­–ç•¥è¯¦ç»†è¯´æ˜**ï¼š

| çŠ¶æ€ | Channelä½¿ç”¨ç‡ | è¡Œä¸º                 | ä¸šåŠ¡å½±å“     |
| ---- | ------------- | -------------------- | ------------ |
| æ­£å¸¸ | 0-60%         | éé˜»å¡å‘é€           | æ— å½±å“       |
| è­¦å‘Š | 60-80%        | éé˜»å¡ï¼Œä½†è®°å½•å‘Šè­¦   | æ— å½±å“       |
| æ‹¥å µ | 80-99%        | éé˜»å¡ï¼Œé«˜ä¼˜å…ˆçº§å‘Šè­¦ | è½»å¾®å»¶è¿Ÿ     |
| æ»¡è½½ | 100%          | **é˜»å¡å‘é€ç«¯**       | ä¸šåŠ¡çº¿ç¨‹ç­‰å¾… |

**å…³é”®è®¾è®¡å†³ç­–**ï¼š

- **ä¸ºä»€ä¹ˆé˜»å¡è€Œä¸ä¸¢å¼ƒ**ï¼Ÿå› ä¸ºPRDè¦æ±‚"é›¶ä¸¢å¤±"
- **10,000å®¹é‡ä¾æ®**ï¼Ÿ
  - 500æ¡/ç§’å³°å€¼åå Ã— 20ç§’ç¼“å†² = 10,000æ¡
  - æ¯æ¡LogRecordçº¦1KB â†’ 10MBå†…å­˜

**èƒŒå‹å¤„ç†æµç¨‹**ï¼š

```
å‘é€æ—¥å¿—
    â†“
Channelæœªæ»¡? 
    â”œâ”€ æ˜¯ â†’ ç«‹å³å…¥é˜Ÿï¼ˆéé˜»å¡ï¼‰
    â””â”€ å¦ â†’ é˜»å¡ç­‰å¾…ç©ºä½
         â†“
    Workeræ¶ˆè´¹åé‡Šæ”¾ç©ºä½
         â†“
    å‘é€ç«¯æ¢å¤
```

### 8.2 Channelåº“é€‰å‹å†³ç­– - âœ… å·²å®ç°

**æŠ€æœ¯é€‰å‹å†³ç­–**ï¼š
- æœ€ç»ˆé€‰æ‹©ï¼š`crossbeam-channel` v0.5
- å†³ç­–ä¾æ®ï¼š
  â”œâ”€ æ€§èƒ½ï¼šé›¶åˆ†é…bounded channel
  â”œâ”€ å¯é æ€§ï¼šç»è¿‡Servoæµè§ˆå™¨éªŒè¯
  â””â”€ ç”Ÿæ€ï¼šä¸ä¾èµ–tokio runtime

**æ›¿ä»£æ–¹æ¡ˆå¯¹æ¯”**ï¼š
| åº“ | ä¼˜ç‚¹ | ç¼ºç‚¹ | ç»“è®º |
|----|------|------|------|
| crossbeam-channel | æ€§èƒ½æœ€ä¼˜,ç‹¬ç«‹è¿è¡Œ | æ— asyncæ”¯æŒ | âœ… å·²å®ç° |
| tokio::mpsc | asyncç”Ÿæ€å¥½ | éœ€è¦runtime,æ€§èƒ½ç•¥ä½ | âŒ ä¸ç”¨ |
| std::sync::mpsc | æ ‡å‡†åº“é›¶ä¾èµ– | æ€§èƒ½å·®,APIå—é™ | âŒ ä¸ç”¨ |

**ä¸ºä»€ä¹ˆé€‰æ‹©crossbeam-channel**ï¼š

1. **æ€§èƒ½ä¼˜åŠ¿**ï¼š
   - é›¶åˆ†é…å‘é€ï¼šå‡å°‘GCå‹åŠ›
   - æ— é”è®¾è®¡ï¼šæé«˜å¹¶å‘æ€§èƒ½
   - ç¼“å­˜å‹å¥½ï¼šå‡å°‘å†…å­˜è®¿é—®å»¶è¿Ÿ

2. **æ¶æ„é€‚é…**ï¼š
   - Workeræ˜¯OSçº¿ç¨‹ï¼Œä¸éœ€è¦async
   - ä¸ä¾èµ–tokio runtimeï¼Œä¿æŒè½»é‡çº§
   - ä¸Rustæ ‡å‡†åº“å…¼å®¹æ€§å¥½

3. **å¯é æ€§éªŒè¯**ï¼š
   - Servoæµè§ˆå™¨é•¿æœŸä½¿ç”¨
   - ç¤¾åŒºç»´æŠ¤æ´»è·ƒ
   - APIç¨³å®šï¼Œæ— é‡å¤§bugæŠ¥å‘Š

## ã€æ•…éšœå¤„ç† - èƒŒå‹æ§åˆ¶æœºåˆ¶ã€‘
**çŠ¶æ€**ï¼šâœ… å·²å®ç°
**å®ç°æ–‡ä»¶**ï¼šsrc/manager.rs
**æ£€æŸ¥ç»“æœ**ï¼š
- crossbeam-channelæœ‰ç•Œé€šé“ï¼ˆå®¹é‡10,000ï¼‰
- èƒŒå‹è§¦å‘æ—¶é˜»å¡å‘é€ç«¯ä¿è¯é›¶ä¸¢å¤±
- èƒŒå‹ç­–ç•¥è¯¦ç»†å®ç°ï¼ˆæ­£å¸¸/è­¦å‘Š/æ‹¥å µ/æ»¡è½½ï¼‰
- 20ç§’ç¼“å†²æ—¶é—´è®¾è®¡åˆç†

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼šæ— 

## ã€æ•…éšœå¤„ç† - é™çº§çŸ©é˜µã€‘
**çŠ¶æ€**ï¼šâœ… å·²å®ç°
**å®ç°æ–‡ä»¶**ï¼šsrc/sink/database.rs, src/sink/file.rs, src/archive/
**æ£€æŸ¥ç»“æœ**ï¼š
- DBè¿æ¥å¤±è´¥â†’FileSinké™çº§ï¼ˆdb_fallback.logï¼‰âœ…
- ç£ç›˜æ»¡â†’Consoleé™çº§+ç©ºé—´ç›‘æ§âœ…
- S3ä¸å¯è¾¾â†’æœ¬åœ°ä¿ç•™å½’æ¡£æ–‡ä»¶âœ…
- åŠ å¯†å¯†é’¥é”™è¯¯â†’æ˜æ–‡å†™å…¥+è­¦å‘Šâœ…
- Channelæ»¡â†’èƒŒå‹é˜»å¡âœ…

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼šæ— 

## ã€æ•…éšœå¤„ç† - é”™è¯¯æ¢å¤æµç¨‹ã€‘
**çŠ¶æ€**ï¼šâœ… å·²å®ç°
**å®ç°æ–‡ä»¶**ï¼šsrc/manager.rs, src/sink/
**æ£€æŸ¥ç»“æœ**ï¼š
- ç«‹å³é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼Œé—´éš”é€’å¢ï¼‰âœ…
- é”™è¯¯ä¿¡æ¯è®°å½•åˆ°error.logâœ…
- consecutive_failuresè®¡æ•°å™¨å’Œé˜ˆå€¼åˆ¤æ–­âœ…
- è‡ªåŠ¨é™çº§åˆ°fallback sinkâœ…
- åå°å¥åº·æ£€æŸ¥å’Œè‡ªåŠ¨æ¢å¤âœ…

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼šæ— 

## ã€ä»£ç è´¨é‡è¯„ä¼° - æ€»ä½“è¯„ä»·ã€‘
**çŠ¶æ€**ï¼šâš ï¸ éƒ¨åˆ†å®ç°
**å®ç°æ–‡ä»¶**ï¼šå…¨é¡¹ç›®ä»£ç æ£€æŸ¥
**æ£€æŸ¥ç»“æœ**ï¼š
- åŠŸèƒ½å®Œæ•´æ€§ï¼š85% PRDéœ€æ±‚è¦†ç›–ç‡ï¼Œä½†å­˜åœ¨å…³é”®åŠŸèƒ½ç¼ºé™·
- æŠ€æœ¯ç¬¦åˆæ€§ï¼š80% TDDæ¶æ„è®¾è®¡åŸºæœ¬è½åœ°ï¼Œä½†éƒ¨åˆ†å®ç°ä¸å®Œæ•´
- ä»£ç è´¨é‡ï¼š75% ä»£ç è´¨é‡ä¸­ç­‰åä¸Šï¼Œå­˜åœ¨é”™è¯¯å¤„ç†å’Œæ–‡æ¡£é—®é¢˜
- æ€§èƒ½è¡¨ç°ï¼šè‰¯å¥½ï¼ŒåŸºç¡€æ¶æ„æ»¡è¶³è®¾è®¡è¦æ±‚

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼š
- ä¿®å¤ç¯å¢ƒå˜é‡è¦†ç›–æœºåˆ¶ç¼ºé™·
- å®ç°Parquetæ ¼å¼å½’æ¡£å¯¼å‡º
- å®Œå–„HTTPç›‘æ§ç«¯ç‚¹é›†æˆ
- å‡å°‘ä»£ç ä¸­çš„unwrapä½¿ç”¨ï¼Œæ”¹è¿›é”™è¯¯å¤„ç†
- å¢åŠ å…¬å…±APIæ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹